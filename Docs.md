
# 챗봇 채팅 개발 문서
## 목차
### 1. **이해하기**
   - **기능 소개**  
     : 챗봇 채팅의 주요 기능과 작동 방식에 대한 설명  
        - 메시지
        - 접속 인원
        - 접속 목록
        - 챗봇
  
   - **실제 사용 예시**  
     1. 메시지 (메시지 수신/발신 및 상태 처리 샘플 코드)
     2. 접속 인원 (실시간 접속 인원 표시 샘플 코드)
     3. 접속 목록 (접속 중인 사용자 목록을 받아오는 샘플 코드)
     4. 챗봇 (사용자와 챗봇의 기본 대화 흐름 샘플 코드)

   - **지원하는 기능**  
     : 기능별 JavaScript 활용 링크 안내
     1. 메시지 - [JavaScript 세부설명 이동]
     2. 접속 인원 - [JavaScript 세부설명 이동]
     3. 접속 목록 - [JavaScript 세부설명 이동]
     4. 챗봇 - [JavaScript 세부설명 이동]

### 2. **JavaScript 세부 설명**
   - **메시지 수신/발신/상태**  
     : 클라이언트-서버 간 메시지 송수신 및 상태 처리 샘플 코드
   - **접속 인원**  
     : 실시간 접속 인원 수 관리 로직
   - **접속 목록**  
     : 관리자 패널에서 접속 사용자 목록을 표시하는 방법
   - **챗봇**  
     : 대화형 인터페이스 구현과 사용자 입력 처리

<!-- 
### 3. **보완 사항** (선택적)
   - **상호작용 흐름**: 메시지 전송 및 응답 과정을 다이어그램으로 설명
   - **에러 처리**: 메시지 전송 실패 시 에러 처리 및 상태 코드 설명
   - **보안 고려 사항**: 인증/인가 및 데이터 암호화 처리
   - **테스트 및 디버깅 가이드**: 기능별 테스트 및 디버깅 방법
-->

## 1. 이해하기
이 섹션은 챗봇의 주요 기능과 작동 방식에 대해 설명합니다.

### 기능소개
---
### 메시지
챗봇 채팅은 관리자와 방문자가 1대1로 연락할 수 있는 기능을 제공합니다. 관리자가 온라인일 때 방문자가 관리자에게 직접 연락할 수 있도록 만들어졌습니다.   

챗봇 메시지는 supabase realtime을 활용하여 실시간 연락이 가능합니다. 메시지로 보낸 메시지는 supabase messages table 속성에 맞춰 하나의 행으로 삽입됩니다. 각 행은 room_id를 포함하고 있어, 주고받는 메시지를 구분할 수 있도록 합니다. 

messages table은 특정 조건에 맞춰 행을 삽입/갱신하며, 메시지 상태를 실시간으로 관리할 수 있습니다.

![](./img/msg-img.png)

> *supabase는 이벤트를 구독하는 기능이 있어, 같은 channel을 구독하고 있다면 이벤트 동작을 공유할 수 있습니다.*

### 접속 인원
챗봇 채팅은 현재 접속한 인원을 관리하는 기능을 제공합니다. 관리자와 사용자의 온라인 여부를 확인하기 위해 만들어졌습니다. 

챗봇 접속 인원은 supabase realtime을 활용하여 접속 인원을 실시간으로 관리합니다. 접속 인원 상태 추적은 supabase에서 자동으로 이뤄집니다.    

접속자는 user_status table 속성에 맞춰 하나의 행으로 삽입됩니다. 접속자 상태는 특정 조건에 맞춰 갱신되며, 접속자 목록이 동기화 될 때 room_id를 기준으로 행 중복 삽입이 제한됩니다.  

- **관리자, 접속자 상태 처리**

  ![](./img/user_status_admin.png)

- **사용자, 접속자 상태처리**

  ![](./img/user_status_client.png)

### 접속 목록
챗봇 채팅은 관리자에게 접속 목록 기능을 제공합니다. 다수의 이용자와 1:1 연락을 위해 만들어졌습니다. 해당 기능은 관리자만 사용할 수 있습니다.

접속 목록 기능은 접속 인원 기능을 활용하여 관리자를 제외한 현재 접속자를 보여줍니다. 접속 목록 기능은 접속 인원 기능을 사용합니다.  

### 챗봇
챗봇 채팅은 접속자의 응답에 따라 반응하는 챗봇 기능을 제공합니다. 관리자가 오프라인일 때 방문자의 의문을 해소할 수 있도록 만들어졌습니다.

챗봇은 supabase database를 활용하여 bot_questions table에서 등록된 응답을 불러옵니다. 

응답은 bot_questions table 속성에 맞춰 삽입되어 있으며, 상위 질문과 하위 답변으로 구성되어 있습니다. 각 응답 id는 하위 답변일수록 상위 질문 id가 하이픈으로 연결된 문자열 구조로 구성되어 있습니다.

![](./img/chatbot.png)

### 실제 사용 예시
---
### 메시지 
(메시지 수신/발신 및 상태 처리 샘플 코드)
### 접속 인원 
(실시간 접속 인원 표시 샘플 코드)
### 접속 목록 
(접속 중인 사용자 목록을 받아오는 샘플 코드)
### 챗봇 
(사용자와 챗봇의 기본 대화 흐름 샘플 코드)